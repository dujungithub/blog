

# 跨域：配置window版本ngnix进行代理

1,	下载nginx http://nginx.org/en/download.html  

2,	启动nginx	

​		(1)直接双击nginx.exe，双击后一个黑色的弹窗一闪而过

​		(2)打开cmd命令窗口，切换到nginx解压目录下，输入命令 nginx.exe 或者 start nginx ，回车即可

3,	检查nginx是否启动成功

​		直接在浏览器地址栏输入网址 http://localhost:80，回车，出现以下页面说明启动成功

​		也可以在cmd命令窗口输入命令 **tasklist /fi "imagename eq nginx.exe"** ，出现如下结果说明启动成功

4,	修改端口

​		nginx的配置文件是conf目录下的nginx.conf，默认配置的nginx监听的端口为80，如果80端口被占用可以修改为未被占用的端口即可

```
	server {
    listen       80;
    server_name  localhost;}
```

​		检查80端口是否被占用的命令是： netstat -ano | findstr 0.0.0.0:80 或 netstat -ano | findstr "80"

​		当我们修改了nginx的配置文件nginx.conf 时，不需要关闭nginx后

​		重新启动nginx，只需要执行命令**nginx -s reload** 即可让改动生效

5,	关闭nginx

​		如果使用cmd命令窗口启动nginx，关闭cmd窗口是不能结束nginx进程的，可使用两种方法关闭nginx

​		(1)输入nginx命令  nginx -s stop(快速停止nginx)  或  nginx -s quit(完整有序的停止nginx)

​		(2)使用taskkill   taskkill /f /t /im nginx.exe

6,	nginx配置静态资源

​		将静态资源（如jpg|png|css|js等）放在如下配置的f:/nginx-1.12.2/static目录下，然后在nginx配置文件中		做如下配置(注意：静态资源配置只能放在 location / 中)，浏览器中访问  http://localhost:80/1.png 即可访问到 f:/nginx-1.12.2/static目录下的 1.png图片

7,	 路由转发代理

​		前端用户访问：nginx服务地址

​		nginx服务地址中前端指向一个地址，后端指向一个地址，解决了前后端跨域问题

​		配置代理服务：服务名自定义api_server,tomcat_server等

> ```json
> listen       8888;
> 
> server_name  127.0.0.1;
> upstream tomcat_server{
> 	server localhost:8008 weight=2;
> 	server 192.168.70.128:8008 weight=1;
> }
> upstream api_server{
> 	server 192.168.70.128:3000;
> }
> location / {
>  #配置nginx静态资源
>  #root	D:/nginx/nginx-1.12.2/static/img;
>  #nginx配置前端访问入口
>  index  index.html index.htm;
>  #前端从8888端口跳转，访问8008的前端资源
>  proxy_pass http://tomcat_server;
> }
> location /api {
>  proxy_pass   http://api_server/select;
> }
> 
> ###前端访问：location:80  静态资源指向192.168.70.128:8008  后端接口指向192.168.70.128:3000;
> ###完成跨域处理！！！
> 
> ```

​		通过 proxy_pass 可以实现反向代理

​		通过 rewrite 可以实现路由转发

8,	关于转发地址增加路由入口的处理

​		如：访问：http://192.168.70.128:8888/api/select/ 和访问：http://192.168.70.128:3000/select/应该是一样的。 但是现在http://192.168.70.128:8888/api/select/访问失败

​		解决办法：

```json
    #location /api {
    #	proxy_pass   http://api_server/;
    #}
	#使用如下方式才可以 api_server是自定义转发地址变量
	location ^~ /api/ {
		if ($request_uri ~* "/api/(.*)") {
			proxy_pass http://api_server/$1;
		}
	}
```

# 关于localhost访问特别快而nginx配置代理后转发特别慢的解决

​		前端访问速度特别慢，注意配置中的localhost 改成 127.0.0.1  即可解决！
​		转发服务为开启的服务建议注释掉，如：#server localhost:8008 weight=2;





nginx  访问接口地址  <http://192.168.70.128:8888/api>   

​		    接口转发来自   <http://192.168.70.128:3000/select>  由node连接数据库mysql的地址

nginx  访问前端地址  <http://192.168.70.128:8888/> 		

​			前端资源来自   http://192.168.70.128:8008



![img](C:\Users\dujun-zhcw\Desktop\node-koa-mysql-test\assets\1558399-20190218162940808-2020359026.png)

![img](C:\Users\dujun-zhcw\Desktop\node-koa-mysql-test\assets\1558399-20190218171357125-1872840115.png)





## header配置传参-nginx转发代理-同时转发请求头

![1590042442983](D:\nginx\nginx-1.12.2\assets\1590042442983.png)

```nginx
http {

	underscores_in_headers on;#允许参数带有下划线
    server {
		location ^~ /api/ {
			#去除登录验证的请求头添加
			#proxy_set_header xxl_sso_sessionid 'NWVjMjU0YzY0NTcwNmU5MDMzMjUxYjE1XzAxOTk3MTAwODg2YTRkNWM4ZGIwYzE2MjZiZjE2NTUw';
			proxy_set_header Host host;
			proxy_set_header X-Real-IP remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			
    		if ($request_uri ~* "/api/(.*)") {
    			#proxy_pass http://api_server/$1;
    			#proxy_pass https://api_server/$1;
    			proxy_pass http://192.168.35.16:8080/$1;
    		}
    	}

	}

}

```

